pipeline {
    agent any

    environment {
        SONARQUBE = 'sonar'
    }

    triggers {
        githubPush()
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/Vinutha1621/my-app.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'pip3 install -r requirements.txt'
            }
        }

        stage('Run Tests') {
            steps {
                sh 'sh '/var/lib/jenkins/.local/bin/pytest --junitxml=result.xml'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                withSonarQubeEnv('sonar') {
                    sh """
                    sonar-scanner \
                      -Dsonar.projectKey=my-app \
                      -Dsonar.sources=. \
                      -Dsonar.python.version=3 \
                      -Dsonar.host.url=http://localhost:9000
                    """
                }
            }
        }

        stage('Package') {
            steps {
                sh '''
                mkdir -p build
                zip -r build/my-app.zip app/
                '''
            }
        }

        stage('Docker Login') {
            steps {
                sh "docker login localhost:5000 -u admin -p admin"
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t localhost:5000/my-app:${BUILD_NUMBER} ."
            }
        }

        stage('Push Docker Image') {
            steps {
                sh "docker push localhost:5000/my-app:${BUILD_NUMBER}"
            }
        }

        stage('Deploy') {
            steps {
                sh 'bash utility/deploy.sh ${BUILD_NUMBER}'
            }
        }
    }

    post {
        success {
            echo "✅ Build and Deployment completed successfully!"
        }
        failure {
            echo "❌ Build or Deployment failed!"
        }
    }
}


